/* pianod web client - communication class
   Copr. 2013-2015 Perette Barella/Devious Fish
   All rights reserved.
*//* Message number definitions */function PianoConnection(e,t,n){function m(){return{diagnostics:[],data:[],record:[]}}function g(e){return!isNaN(parseFloat(e))&&isFinite(e)}function y(e){var t={code:parseInt(e.substring(0,3),10),text:e.substring(4)},n=t.text.split(": ");t.tag=n[0],t.rawvalue=n.splice(1).join(": "),t.words=t.rawvalue.split(/\s+/);if(t.code in i&&"words"in i[t.code]){var r=i[t.code].words;t.wordflags={};for(var s=0;s<r.length;s++)t.wordflags[r[s]]=t.words.indexOf(r[s])>=0;t.words.length>=2&&g(t.words[1])&&(t.wordflags.rated=parseFloat(t.words[1]))}return t.value=t.wordflags||t.rawvalue,t}function b(e,t){for(var n in e)t[n]=e[n]}function w(e){var t=o[a];typeof t=="undefined"?(alert("Excess 200/400 Success/Failure responses received!"),console.log("Excess 200/400 Success/Failure responses received!")):(delete o[a++],e.ok=e.code>=MSG.SUCCESS_START&&e.code<=MSG.SUCCESS_END,s&&console.log("Received response: ",e),t.handler(e))}function E(){var e={};for(var t in l)e[i[t].name]=l[t].value;f.data.push(l),f.record.push(e),l={}}function S(e){s&&console.log(e.data);var t=y(e.data);(t.code==MSG.DATA_START||t.code==MSG.DATA_END)&&Object.keys(l).length>0&&E();if(t.code==MSG.DATA_START)d=r.COMMAND;else if(t.code>=MSG.SUCCESS_START&&t.code<=MSG.SUCCESS_END||t.code>=MSG.ERROR_START&&t.code<=MSG.ERROR_END)d==r.COMMAND&&t.code!=MSG.DATA_END&&(alert("Received "+t.code+" instead of "+MSG.DATA_END),console.log("Received ",t.code," instead of ",MSG.DATA_END),console.log("Command: ",o[a].command)),t.command=o[a].command,b(t,f),f.record.length==1&&b(f.record[0],f),t=f,f=m(),w(t),d=r.DISCRETE;if(d==r.COMMAND&&t.code>=MSG.INFO_START&&t.code<=MSG.ERROR_END)t.code>=MSG.INFO_START&&t.code<=MSG.INFO_END?(t.code in l&&E(),l[t.code]=t):t.code>=MSG.DIAG_START&&t.code<=MSG.DIAG_END&&f.diagnostics.push(t);else{var n=c[t.code]||[];for(var i=0;i<n.length;i++)n[i](t);h[t.code]=t}}function x(e){for(var t=p.length-1;t>=0;t--)p[t](e)}var r={COMMAND:1,DISCRETE:2},i={111:{name:"id"},112:{name:"album"},113:{name:"artist"},114:{name:"song"},115:{name:"playlist"},116:{name:"rating",words:["seed","albumseed","artistseed"]},117:{name:"url"},118:{name:"art"},119:{name:"genre"},120:{name:"playlistrating",words:[]},121:{name:"explanation"},122:{name:"owner"},123:{name:"source"},124:{name:"sourcename"},125:{name:"year"},126:{name:"duration"},127:{name:"action",words:["rate","request","seed","albumseed","artistseed"]},132:{name:"info"},136:{name:"privilege",words:["disabled","guest","listener","admin","user","service","influence","tuner"]},148:{name:"room"}},s=!1,o={0:{id:0,command:"connect",handler:t||""}},u=1,a=0,f,l={},c={},h={},p=[],d=r.DISCRETE,v=new WebSocket(e);return f=m(),typeof n=="function"&&p.push(n),v.onmessage=function(e){S(e)},v.onopen=function(e){},v.onclose=function(e){x(e)},v.onerror=function(e){x(e)},{request_time_status:function(){v.send(" ")},send_command:function(e,t){if(typeof e=="object"){for(var n=0;n<e.length;n++)e[n]=e[n].toString().replace(/" /g," ");e='"'+e.join('" "')+'"'}t=t||function(){};var r={id:u,command:e,handler:t};o[u++]=r,v.send(e)},on_close:function(e){p.push(e)},subscribe:function(e,t,n){typeof e!="object"&&(e=[e]),typeof n=="undefined"&&(n=!0);for(var r=0;r<e.length;r++){var i=e[r];i in c||(c[i]=[]),c[i].push(t),s&&console.log("subscribed ",t," to ",i),n&&i in h&&t(h[i])}},is_success:function(e){return e>=MSG.SUCCESS_START&&e<=MSG.SUCCESS_END},is_error:function(e){return e>=MSG.ERROR_START&&e<=MSG.ERROR_END},get_sorted_column:function(e,t){var n=[];for(var r=0;r<e.length;r++)n.push(e[r][t]);return n.sort(function(e,t){var n=e.toLowerCase(),r=t.toLowerCase();return n<r?-1:n>r?1:0}),n},sort_on_field:function(e,t){return typeof t!="object"&&(t=[t]),e.sort(function(e,n){for(var r=0;r<t.length;r++){var i="",s="";t[r]in e&&(i=e[t[r]].toLowerCase()),t[r]in n&&(s=n[t[r]].toLowerCase()||"");if(i<s)return-1;if(i>s)return 1}return 0})}}}function PianodViewer(e,t){function p(e,t){if(e==MSG.ART)$(h.find(".albumart")).attr("src",t===""?"no-art.jpeg":t);else{var r=n[e];$(h.find("."+r)).toggle(t!==""),$(h.find("."+r+" .value")).text(t)}}function d(){for(var e=0;e<r.length;e++)p(r[e],"")}function v(){var e=new Date,t=Math.round((e.getTime()-o)/1e3),n=Math.floor(t/60),r=t%60;h.find(".timepoint").text(n+":"+(r<=9?"0":"")+r);if(u>0){var i=Math.round(t*1e4/u)/100;i>100&&(i=100),h.find(".progressbar").css("width",i+"%")}}function m(e){h.find(".offline").hide(),h.find(".idle").hide(),h.find(".playing").show(),h.find(".playbackstatus.paused").toggle(e.code==MSG.PAUSED),h.find(".playbackstatus.stalled").toggle(e.code==MSG.STALLED),e.code==MSG.PLAYING?typeof f=="undefined"&&(f=setInterval(v,1e3)):typeof f!="undefined"&&(clearInterval(f),f=undefined);var t=new Date,n=e.words[0].split("/");h.find(".duration").text(n[1]);var r=n[0].split(":"),i=n[1].split(":"),s=parseInt(r[0],10)*60+parseInt(r[1],10);u=parseInt(i[0],10)*60+parseInt(i[1],10),o=t.getTime()-s*1e3,v()}function g(){c=new PianoConnection(e,function(){c.subscribe([MSG.PLAYING,MSG.PAUSED,MSG.STALLED],m,!1),c.subscribe(MSG.IDLE,function(){h.find(".offline").hide(),h.find(".playing").hide(),h.find(".idle").show()},!1),c.subscribe(MSG.NOPLAYLIST,function(){p(MSG.SELECTEDPLAYLIST,"")},!1),c.subscribe(MSG.SELECTEDPLAYLIST,function(e){p(e.code,e.words.slice(1))},!1),c.subscribe(r,function(e){p(e.code,e.value)}),c.subscribe(MSG.TRACKCOMPLETE,function(){d()}),c.request_time_status(),c.send_command("status")},function(){h.find(".idle").hide(),h.find(".playing").hide(),h.find(".offline").show(),c=undefined})}var n={12:"playlistname",112:"albumname",113:"artistname",114:"trackname",115:"songplaylist",123:"songsourcetype",124:"songsourcename"},r=[MSG.ALBUM,MSG.ARTIST,MSG.SONG,MSG.ART,MSG.RATING,MSG.PLAYLIST,MSG.ID,MSG.URL,MSG.YEAR,MSG.ACTIONS,MSG.PLAYLISTRATING,MSG.SOURCE,MSG.NAME],i=!1,s=!1,o=0,u=0,a,f,l=!1,c,h;return h=$("#"+(typeof t=="undefined"?"pianod":t)),h.find(".playbackstatus").hide(),h.find(".idle").hide(),h.find(".playing").hide(),h.find(".offline").show(),h.show(),d(),g(),a=setInterval(function(){typeof c=="undefined"&&g()},3005),{destroy:function(){clearInterval(a),typeof f!="undefined"&&clearInterval(f),h.hide()}}}MSG={PLAYING:1,PAUSED:2,STALLED:3,TRACKCOMPLETE:4,INTERTRACK:5,IDLE:6,STOPPED:7,REQUESTS:8,RANDOMPLAY:9,SELECTEDSOURCE:11,SELECTEDPLAYLIST:12,MIX_CHANGED:21,PLAYLISTS_CHANGED:22,USERRATINGS_CHANGED:23,SOURCES_CHANGED:24,YELL:31,ACTIVITY:32,STATUS:33,SOURCESTATUS:34,QUEUERANDOMIZE:41,WELCOME:100,ID:111,ALBUM:112,ARTIST:113,SONG:114,PLAYLIST:115,RATING:116,URL:117,ART:118,GENRE:119,PLAYLISTRATING:120,EXPLANATION:121,OWNER:122,SOURCE:123,NAME:124,YEAR:125,DURATION:126,ACTIONS:127,INFO:132,PRIVILEGES:136,VOLUME:141,HISTORYSIZE:142,AUDIOQUALITY:143,AUTOTUNE_MODE:144,PAUSE_TIMEOUT:146,PLAYLIST_TIMEOUT:147,PROXY:161,CONTROLPROXY:162,RPCHOST:163,RPCTLSPORT:164,PARTNERUSER:165,PARTNERPASSWORD:166,DEVICE:167,ENCRYPTION_PASSWORD:168,DECRYPTION_PASSWORD:169,SOURCE_USER:170,SOURCE_PASSWORD:171,TLSFINGERPRINT:172,OUTPUT_DRIVER:181,OUTPUT_DEVICE:182,OUTPUT_ID:183,OUTPUT_SERVER:184,S_OK:200,DATA_START:203,DATA_END:204,S_MATCH:206,S_ROUNDING:207,S_PENDING:210,EVENT_START:0,EVENT_END:99,INFO_START:100,INFO_END:199,SUCCESS_START:200,SUCCESS_END:299,DIAG_START:300,DIAG_END:399,ERROR_START:400,WRONG_STATE:405,ERROR_END:499,FAILURE_START:500,FAILURE_PLAYER_EMPTY:501,FAILURE_END:599},PianodFinder={parse_query_strings:function(){var e={},t=window.location.toString().split("?");if(t.length>1){var n=t[1].split("&");for(var r=0;r<n.length;r++){var i=n[r].split("=");e[i[0]]=i[1]}}return e},get_url_info:function(){var e=window.location.toString().split("?");if(e.length<1)return;var t={};t.url=e;var n=e[0].split("/");if(n.length<=3)return;t.service=n[3]||"",t.path=n.splice(3).join("/");var r=n[0];if(r!="http:"&&r!="https:")return;t.scheme=r,t.secure=r=="https:";var i=n[2].toLowerCase();return t.domain=i,t.fromweb=i.match("deviousfish.com"),t},get_pianod_url:function(){var e=PianodFinder.get_url_info();if(typeof e=="undefined")return;if(e.fromweb)return;return(e.secure?"wss://":"ws://")+e.domain+"/"+e.service},get_best_url:function(){var e=PianodFinder.parse_query_strings();if("server"in e){var t=e.server,n=e.room||"pianod";if(typeof t!="undefined"&&t!=="")return"ws://"+t+"/"+n}var r=PianodFinder.get_pianod_url();return typeof r!="undefined"?r:"ws://house.perette.barella.org:4446/pianod"}};