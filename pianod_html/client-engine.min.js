/* pianod web client - communication class
   Copr. 2013-2015 Perette Barella/Devious Fish
   All rights reserved.
*//* Message number definitions */function PianoConnection(e,t,n){function m(){return{diagnostics:[],data:[],record:[]}}function g(e){return!isNaN(parseFloat(e))&&isFinite(e)}function y(e){var t={code:parseInt(e.substring(0,3),10),text:e.substring(4)},n=t.text.split(": ");t.tag=n[0],t.rawvalue=n.splice(1).join(": "),t.words=t.rawvalue.split(/\s+/);if(t.code in i&&"words"in i[t.code]){var r=i[t.code].words;t.wordflags={};for(var s=0;s<r.length;s++)t.wordflags[r[s]]=t.words.indexOf(r[s])>=0;t.words.length>=2&&g(t.words[1])&&(t.wordflags.rated=parseFloat(t.words[1]))}return t.value=t.wordflags||t.rawvalue,t}function b(e,t){for(var n in e)t[n]=e[n]}function w(e){var t=o[a];typeof t=="undefined"?(alert("Excess 200/400 Success/Failure responses received!"),console.log("Excess 200/400 Success/Failure responses received!")):(delete o[a++],e.ok=e.code>=MSG.SUCCESS_START&&e.code<=MSG.SUCCESS_END,s&&console.log("Received response: ",e),t.handler(e))}function E(){var e={};for(var t in l)e[i[t].name]=l[t].value;f.data.push(l),f.record.push(e),l={}}function S(e){s&&console.log(e.data);var t=y(e.data);(t.code==MSG.DATA_START||t.code==MSG.DATA_END)&&Object.keys(l).length>0&&E();if(t.code==MSG.DATA_START)d=r.COMMAND;else if(t.code>=MSG.SUCCESS_START&&t.code<=MSG.SUCCESS_END||t.code>=MSG.ERROR_START&&t.code<=MSG.ERROR_END)d==r.COMMAND&&t.code!=MSG.DATA_END&&(alert("Received "+t.code+" instead of "+MSG.DATA_END),console.log("Received ",t.code," instead of ",MSG.DATA_END),console.log("Command: ",o[a].command)),t.command=o[a].command,b(t,f),f.record.length==1&&b(f.record[0],f),t=f,f=m(),w(t),d=r.DISCRETE;if(d==r.COMMAND&&t.code>=MSG.INFO_START&&t.code<=MSG.ERROR_END)t.code>=MSG.INFO_START&&t.code<=MSG.INFO_END?(t.code in l&&E(),l[t.code]=t):t.code>=MSG.DIAG_START&&t.code<=MSG.DIAG_END&&f.diagnostics.push(t);else{var n=c[t.code]||[];for(var i=0;i<n.length;i++)n[i](t);h[t.code]=t}}function x(e){for(var t=p.length-1;t>=0;t--)p[t](e)}var r={COMMAND:1,DISCRETE:2},i={111:{name:"id"},112:{name:"album"},113:{name:"artist"},114:{name:"song"},115:{name:"playlist"},116:{name:"rating",words:["seed","albumseed","artistseed"]},117:{name:"url"},118:{name:"art"},119:{name:"genre"},120:{name:"playlistrating",words:[]},121:{name:"explanation"},122:{name:"owner"},123:{name:"source"},124:{name:"sourcename"},125:{name:"year"},126:{name:"duration"},127:{name:"action",words:["rate","request","seed","albumseed","artistseed"]},132:{name:"info"},136:{name:"privilege",words:["disabled","guest","listener","admin","user","service","influence","tuner"]},148:{name:"room"}},s=!1,o={0:{id:0,command:"connect",handler:t||""}},u=1,a=0,f,l={},c={},h={},p=[],d=r.DISCRETE,v=new WebSocket(e);return f=m(),typeof n=="function"&&p.push(n),v.onmessage=function(e){S(e)},v.onopen=function(e){},v.onclose=function(e){x(e)},v.onerror=function(e){x(e)},{request_time_status:function(){v.send(" ")},send_command:function(e,t){if(typeof e=="object"){for(var n=0;n<e.length;n++)e[n]=e[n].toString().replace(/" /g," ");e='"'+e.join('" "')+'"'}t=t||function(){};var r={id:u,command:e,handler:t};o[u++]=r,v.send(e)},on_close:function(e){p.push(e)},subscribe:function(e,t,n){typeof e!="object"&&(e=[e]),typeof n=="undefined"&&(n=!0);for(var r=0;r<e.length;r++){var i=e[r];i in c||(c[i]=[]),c[i].push(t),s&&console.log("subscribed ",t," to ",i),n&&i in h&&t(h[i])}},is_success:function(e){return e>=MSG.SUCCESS_START&&e<=MSG.SUCCESS_END},is_error:function(e){return e>=MSG.ERROR_START&&e<=MSG.ERROR_END},get_sorted_column:function(e,t){var n=[];for(var r=0;r<e.length;r++)n.push(e[r][t]);return n.sort(function(e,t){var n=e.toLowerCase(),r=t.toLowerCase();return n<r?-1:n>r?1:0}),n},sort_on_field:function(e,t){return typeof t!="object"&&(t=[t]),e.sort(function(e,n){for(var r=0;r<t.length;r++){var i="",s="";t[r]in e&&(i=e[t[r]].toLowerCase()),t[r]in n&&(s=n[t[r]].toLowerCase()||"");if(i<s)return-1;if(i>s)return 1}return 0})}}}function setup_rating_widget(e){function t(e,t){var n=e.width(),r=t.pageX-e.offset().left,i=Math.round(r/n*10)/2;return i<.5&&(i=.5),i>5&&(i=5),i}function n(e,t){e.find(".hoverrating").css("visibility",t?"inherit":"hidden"),e.find(".currentrating").css("visibility",t?"hidden":"inherit")}$(e).html('<span class="outline" visibility="hidden">☆☆☆☆☆</span><span class="hoverrating" visibility="hidden"><span class="value"></span></span><span class="currentrating"><span class="value"></span></span><span class="spacer" visibility="hidden">☆☆☆☆☆</span>').addClass("button").addClass("ratingwidget").hover(function(){n($(this),!0)},function(){n($(this),!1)}).mousemove(function(e){$(this).rating(t($(this),e),!0)})}function execute(e,t){viewmanager.execute(e,t)}function TrackView(e,t){function y(e){m=e.length!==0;var t=$("#addfromtracktarget");t.find("option").slice(1).remove();var n=$("#playlists");n.html("");for(var r=0;r<e.length;r++){var i=$("<option />").prop("value",e[r].id).text(e[r].name);t.append($(i)),n.append(i.clone())}if(!m){var s="<option disabled>"+translate("No playlists")+"</option>";t.append(s),n.html(s)}x()}function b(e){g=e.length>1;var t=$("#addfromtracksource");t.find("option").remove();for(var n=0;n<e.length;n++)e[n].id!=1&&t.append($("<option />").prop("value",e[n].id).text(e[n].fullname));g||t.append("<option disabled>"+translate("No usable sources.")+"</option>");var r=t.find("option").clone();t=$("#addfromsearchsource"),t.find("option").remove(),t.append(r)}function w(e){$("#trackrating").rating(e.rated||0),$("#trackname .button.seed").toggleClass("selected",e.seed||!1),$("#albumname .button.seed").toggleClass("selected",e.albumseed||!1),$("#artistname .button.seed").toggleClass("selected",e.artistseed||!1)}function E(e){$("#overplayed").toggleClass("disabled",!e.rate&&!0),$("#trackrating").toggleClass("disabled",!e.rate&&!0),$("#trackname .button.seed").toggleClass("disabled",!e.seed&&!0),$("#albumname .button.seed").toggleClass("disabled",!e.albumseed&&!0),$("#artistname .button.seed").toggleClass("disabled",!e.artistseed&&!0)}function S(e,t){if(e==MSG.ART)$("#albumart").attr("src",t||"no-art.jpeg");else if(e==MSG.RATING)w(t||{});else if(e==MSG.URL)$("#additionalinfo").attr("href",t||"");else if(e==MSG.ACTIONS)E(t||{});else{var r=n[e];$("#"+r+" .value").text(t||"")}}function x(){var t=s===0,n=t&!l;n&&$("#albumart").attr("src","no-art.jpeg"),$("#trackdetails").css("visibility",l||!t?"visible":"hidden"),$("#controller").css("visibility",l||!t?"visible":"hidden"),$("#statusbar").css("visibility",t&&l?"visible":"hidden"),$("#controller .time").css("visibility",l?"visible":"hidden"),$("#networkstatus").css("visibility",t&&l&&c?"visible":"hidden"),$("#pausestatus").css("visibility",t&&l&&h?"visible":"hidden"),$("#stoppedstatus").css("visibility",n&&p==MSG.STOPPED?"visible":"hidden"),$("#norequests").css("visibility",n&&p==MSG.REQUESTS?"visible":"hidden"),$("#needplaylists").css("visibility",n&&p==MSG.RANDOMPLAY&&!m?"visible":"hidden");var r=n&&p==MSG.RANDOMPLAY&&m,i=v!="mix"||e.get_view("playlist").mix_selected();$("#needmixselections").css("visibility",r&&!i?"visible":"hidden"),$("#go").css("visibility",r&&i?"visible":"hidden");var o=d;p==MSG.STOPPED?o="Stopped":p==MSG.REQUESTS&&(o="Requests only"),$("#playlistname option:first").text(o)}function T(){$("#nowplaying").toggle(s!==0),$("#playlistname").toggle(s===0),x()}function N(e){o=e;var t=typeof e!="undefined"&&Object.keys(e).length===0;typeof e=="undefined"&&(e={});for(i=0;i<r.length;i++){var n=r[i];S(n,n in e?e[n].value:undefined)}t||T()}function C(){var e=new Date,t=Math.round((e.getTime()-u)/1e3),n=Math.floor(t/60),r=t%60;$("#timepoint").text(n+":"+(r<=9?"0":"")+r);if(a>0){var i=Math.round(t*1e4/a)/100;i>100&&(i=100),$("#progressbar").css("width",i+"%")}}function k(e){var t=new Date,n=e.words[0].split("/");$("#duration").text(n[1]);var r=n[0].split(":"),i=n[1].split(":"),s=parseInt(r[0],10)*60+parseInt(r[1],10);a=parseInt(i[0],10)*60+parseInt(i[1],10),u=t.getTime()-s*1e3,C()}function L(e){var t=e.code;l=t==MSG.PLAYING||t==MSG.PAUSED||t==MSG.STALLED,c=t==MSG.STALLED,h=t==MSG.PAUSED,t==MSG.TRACKCOMPLETE?s===0&&N({}):($("#trackcontrols a").toggleClass("disabled",t==MSG.IDLE),x(),$(".playpause").html(t==MSG.PAUSED||t==MSG.IDLE?"▶":"&nbsp;||&nbsp;")),t==MSG.PLAYING?typeof f=="undefined"&&(f=setInterval(C,1e3)):typeof f!="undefined"&&(clearInterval(f),f=undefined)}function A(n){t.send_command(["QUEUE","LIST",n],function(t){t.ok?(s=n,N(t.data[0])):t.code==MSG.WRONG_STATE?(s=0,e.success("There is nothing playing right now."),N(undefined)):e.error(t)})}function O(){var e=$("#addfromtracktarget").val()==="";$("#addfromtracknewplaylist").toggle(e),$("#doaddseedfromsong").text(translate(e?"Create playlist from song":"Add seed from song")),$("#doaddseedfromalbum").text(translate(e?"Create playlist from album":"Add seed from album")),$("#doaddseedfromartist").text(translate(e?"Create playlist from artist":"Add seed from artist"))}var n={112:"albumname",113:"artistname",114:"trackname",115:"songplaylist"},r=[MSG.ALBUM,MSG.ARTIST,MSG.SONG,MSG.ART,MSG.RATING,MSG.PLAYLIST,MSG.ID,MSG.URL,MSG.YEAR,MSG.ACTIONS,MSG.PLAYLISTRATING],s=0,o,u=0,a=0,f,l=!1,c=!1,h=!1,p=MSG.STOPPED,d="",v="",m=!1,g=!1;return $("#trackrating").rating(0).click(function(){var n=$(this).rating();t.send_command(["RATE","SONG",n,"ID",o[MSG.ID].value],function(t){e.report_status(t),t.ok&&s!==0&&A(s)})}),N(undefined),t.subscribe([MSG.PLAYING,MSG.PAUSED,MSG.STALLED,MSG.IDLE,MSG.TRACKCOMPLETE],L,!1),t.subscribe([MSG.PLAYING,MSG.PAUSED,MSG.STALLED],k,!1),t.subscribe(MSG.TRACKCOMPLETE,function(){s!==0?(s--,T()):track_id=undefined},!1),t.subscribe(MSG.SELECTEDPLAYLIST,function(e){v=e.words[0],d=e.words.slice(1).join(" "),x()}),t.subscribe(r,function(e){s===0&&(typeof o=="undefined"&&(o={}),o[e.code]=e,l=!0,S(e.code,e.value),$("#trackdetails").css("visibility","visible"))}),t.subscribe([MSG.STOPPED,MSG.REQUESTS,MSG.RANDOMPLAY],function(e){p=e.code,x()},!1),t.subscribe([MSG.VOLUME],function(e){$("#volume").val(e.value)}),e.get_view("playlist").subscribe_to_playlists(y),e.get_view("source").subscribe_to_sources(b),{destroy:function(){typeof f!="undefined"&&clearInterval(f)},go_to_history_index:function(e){A(e)},go_to_previous_track:function(){e.clear(),A(s-1)},go_to_next_track:function(){e.clear(),A(s+1)},go_to_current_track:function(){e.clear(),A(0)},toggle_seed:function(n){t.send_command(["SEED","TOGGLE",n,"ID",o[MSG.ID].value],function(t){e.report_status(t),t.ok&&A(s)})},set_volume:function(){var e=$("#volume").val();t.send_command(["VOLUME","LEVEL",e])},show_seeds:function(){var t=$("#songplaylist .value").text();$("#reviseplaylist option").filter(function(){return $(this).text()==t}).prop("selected",!0),e.show("seed"),e.get_view("seed").select_playlist()},showart:function(){var t=$("#albumart").attr("src");t===""?e.error("There is no art available."):$("<img/>").attr("src",t).load(function(){window.open(t,"_blank","status=0,menubar=0,scrollbars=0,resizable=0,location=0,toolbar=0,width="+this.width+",height="+this.height)}).error(function(){e.error("Error zooming album art.")})},rate_overplayed:function(t){e.execute(["RATE","SONG","OVERPLAYED","ID",o[MSG.ID].value],"Song rating temporarily downgraded.")},explain_song:function(){t.send_command(["EXPLAIN","SONG",o[MSG.ID].value],function(t){e.report_status(t),t.ok&&alert(t.explanation)})},add_from_track:function(n){var r=$("#addfromtracktarget"),i=r.val(),s,u,a;if(i===""){s=$("#addfromtrackplaylist").val(),source=$("#addfromtracksource").val();if(s===""){e.error("Please provide a playlist name.");return}u=["WITH","SOURCE","ID",source,"PLAYLIST","CREATE","NAME",s,"FROM",n,"ID",o[MSG.ID].value],a="Created "+s+"."}else u=["SEED","ADD",n,"ID",o[MSG.ID].value,"TO","PLAYLIST","ID",i],a="Added "+n+" seed to "+r.find(":selected").text()+".";t.send_command(u,function(t){t.ok?(e.success(a),$("#addplaylistfromtrack").hide(),r.val(""),$("#addfromtrackplaylist").val(""),O()):e.error(t)})},select_add_target:function(){O()},select_playlist:function(){var t=$("#playlistname").val();if(t=="everything"||t=="mix"||t=="auto"||t=="request")e.execute(["PLAY",t]);else if(t=="stop")e.execute("STOP");else{if(t==="")return;e.execute(["PLAY","PLAYLIST","ID",t])}$("#playlistname option:first").prop("selected",!0)}}}MSG={PLAYING:1,PAUSED:2,STALLED:3,TRACKCOMPLETE:4,INTERTRACK:5,IDLE:6,STOPPED:7,REQUESTS:8,RANDOMPLAY:9,SELECTEDSOURCE:11,SELECTEDPLAYLIST:12,MIX_CHANGED:21,PLAYLISTS_CHANGED:22,USERRATINGS_CHANGED:23,SOURCES_CHANGED:24,YELL:31,ACTIVITY:32,STATUS:33,SOURCESTATUS:34,QUEUERANDOMIZE:41,WELCOME:100,ID:111,ALBUM:112,ARTIST:113,SONG:114,PLAYLIST:115,RATING:116,URL:117,ART:118,GENRE:119,PLAYLISTRATING:120,EXPLANATION:121,OWNER:122,SOURCE:123,NAME:124,YEAR:125,DURATION:126,ACTIONS:127,INFO:132,PRIVILEGES:136,VOLUME:141,HISTORYSIZE:142,AUDIOQUALITY:143,AUTOTUNE_MODE:144,PAUSE_TIMEOUT:146,PLAYLIST_TIMEOUT:147,PROXY:161,CONTROLPROXY:162,RPCHOST:163,RPCTLSPORT:164,PARTNERUSER:165,PARTNERPASSWORD:166,DEVICE:167,ENCRYPTION_PASSWORD:168,DECRYPTION_PASSWORD:169,SOURCE_USER:170,SOURCE_PASSWORD:171,TLSFINGERPRINT:172,OUTPUT_DRIVER:181,OUTPUT_DEVICE:182,OUTPUT_ID:183,OUTPUT_SERVER:184,S_OK:200,DATA_START:203,DATA_END:204,S_MATCH:206,S_ROUNDING:207,S_PENDING:210,EVENT_START:0,EVENT_END:99,INFO_START:100,INFO_END:199,SUCCESS_START:200,SUCCESS_END:299,DIAG_START:300,DIAG_END:399,ERROR_START:400,WRONG_STATE:405,ERROR_END:499,FAILURE_START:500,FAILURE_PLAYER_EMPTY:501,FAILURE_END:599},PianodFinder={parse_query_strings:function(){var e={},t=window.location.toString().split("?");if(t.length>1){var n=t[1].split("&");for(var r=0;r<n.length;r++){var i=n[r].split("=");e[i[0]]=i[1]}}return e},get_url_info:function(){var e=window.location.toString().split("?");if(e.length<1)return;var t={};t.url=e;var n=e[0].split("/");if(n.length<=3)return;t.service=n[3]||"",t.path=n.splice(3).join("/");var r=n[0];if(r!="http:"&&r!="https:")return;t.scheme=r,t.secure=r=="https:";var i=n[2].toLowerCase();return t.domain=i,t.fromweb=i.match("deviousfish.com"),t},get_pianod_url:function(){var e=PianodFinder.get_url_info();if(typeof e=="undefined")return;if(e.fromweb)return;return(e.secure?"wss://":"ws://")+e.domain+"/"+e.service},get_best_url:function(){var e=PianodFinder.parse_query_strings();if("server"in e){var t=e.server,n=e.room||"pianod";if(typeof t!="undefined"&&t!=="")return"ws://"+t+"/"+n}var r=PianodFinder.get_pianod_url();return typeof r!="undefined"?r:"ws://house.perette.barella.org:4446/pianod"}},jQuery.fn.extend({rating:function(e,t){var n=this.find(".hoverrating");if(typeof e=="undefined"){if(n.length===0)return 0;n.css("visibility")=="hidden"&&(n=this.find(".currentrating"));var r=n.attr("class").match(/ rated([0-5][05])/);return typeof r=="undefined"&&(r=this.find(".currentrating").attr("class").match(/ rated([0-5][05])/)),r[1]/10}n.length===0&&setup_rating_widget(this);var i=e.toString().replace(".","");i.length==1&&(i+="0");var s=t?"hoverrating":"currentrating",o=this.find("."+s);return o.attr("class",s+" rated"+i),this},entergize:function(e){this.keydown(function(t){var n=t.keyCode||t.which;return n==13?(e.call(this,t),!1):!0})},enterclicks:function(e){this.keydown(function(t){var n=t.keyCode||t.which;n==13&&$(e).click()})}}),ViewManager=function(){function add_view(e,t){views[e]=t}function update_view(){var e=$(window).innerWidth(),t=$(window).innerHeight(),n=$("#status").css("font-size"),r=Math.round(parseInt(n.replace("px",""),10)*1.3),i=Math.floor(t/r),s=Math.floor(e/250),o=adaptive?Math.floor((e-s*250)/s):0,u=s;i-=u<=1?5:4,i<0&&(i=1),$("#views > div").hide(),$("#views").css("min-height",Math.floor(i*r)+"px");for(var a=0;a<view_order.length&&u>0;a++){var f=view_order[a],l="get_width"in views[f]?views[f].get_width(s,u,i):1;if(l===0)continue;var c=l+" "+l+" "+240*l+"px",h=220+o+"px auto";$("#"+view_order[a]+"view").show().attr("class","columns-"+l).css("-webkit-flex",c).css("flex",c).find(".columnar").css("columns",h).css("-webkit-columns",h),u-=l}$("#views").toggleClass("single",a==1),$("#switcher").toggleClass("collapse",s<=2),$("#switcher .handle").toggleClass("hidden",s>2),$("#switcher .menu").toggle(s>2)}function accordion_click_handler(trigger){accordion=$(trigger.target);var closing=accordion.hasClass("selected");accordion.parent().find("h3").removeClass("selected");if(!closing){var id=accordion.attr("id"),viewname="";if(typeof id!="undefined"){var view=accordion;while(view!=window){view=view.parent();var name=view.attr("id");if(typeof name!="undefined"){if(name=="views"){eval(viewname+".open_"+id+"();");break}viewname=name}}}accordion.addClass("selected")}}function setup_accordions(){$(".accordion h3").click(accordion_click_handler)}function privilege_change(e){var t=e.wordflags;$(".privadmin").toggleClass("disabled",!t.admin),$("input.privadmin").prop("disabled",!t.admin),$(".privuser").toggleClass("disabled",!t.admin&&!t.user),$("input.privuser").prop("disabled",!t.admin&&!t.user),$(".privservice").toggleClass("disabled",!t.service),$(".privinfluence").toggleClass("disabled",!t.influence)}function record_protocol_version(e){var t=e.text.split(".");protocol_version=0;if(t.length>=2){var n=t[0].split(/\s+/);if(n.length>=2&&n[0]=="pianod2"){protocol_version=parseInt(n[1],10);for(var r=1;r<=300;r++)$(".protoend"+r).toggle(protocol_version<r),$(".proto"+r).toggle(protocol_version>=r)}else alert("Service identifies itself as "+(n.length>=2?n[0]:"(unidentified)")+", not pianod2.")}}function create_subscriptions(){privilege_change({wordflags:{admin:!1,user:!1,service:!1,influence:!1}}),piano.subscribe(MSG.WELCOME,record_protocol_version),piano.subscribe(MSG.PRIVILEGES,privilege_change)}VIEWS=["track","playlist","search","source","seed","user","activity","admin"];var piano,view_order=VIEWS,views={},protocol_version=0,adaptive=!0;window.onresize=function(){update_view()};var public_interface={reset:function(){$(document).find("*").off(),$(".accordion").parent().find("h3").removeClass("selected"),$("input[type=text]").val(""),$("input[type=url]").val(""),$("input[type=password]").val(""),$("textarea").val(""),$("select").prop("selectedIndex",0),$(".ratingwidget").html(""),setup_accordions()},show:function(e,t){viewmanager.clear(),$("#switcher.collapse .menu").hide(),t?view_order=[e]:(view_order.length==1&&(view_order=VIEWS),e!="track"&&(view_order.splice(view_order.indexOf("track"),1),view_order.unshift("track")),view_order.splice(view_order.indexOf(e),1),view_order.unshift(e)),update_view()},get_view:function(e){return views[e]},success:function(){$("#status").removeClass("error");var e="";for(i=0;i<arguments.length;i++)e+=translate(arguments[i]);$("#status .value").text(translate(e))},error:function(){$("#status").addClass("error");var e="";for(i=0;i<arguments.length;i++)e+=translate(arguments[i]);$("#status .value").text(translate(e))},clear:function(){$("#status").removeClass("error"),$("#status .value").html("&nbsp;")},report_status:function(e){e.ok?viewmanager.clear():viewmanager.error(e)},init:function(){var e=PianodFinder.parse_query_strings();"size"in e&&(adaptive=e.size!="fixed"),loginview=new LoginView(public_interface,e),add_view("login",loginview),loginview.show()},start_session:function(e){piano=e,create_subscriptions(),activityview=new ActivityView(public_interface,piano),add_view("activity",activityview),playlistview=new PlaylistView(public_interface,piano),add_view("playlist",playlistview),sourceview=new SourceView(public_interface,piano),add_view("source",sourceview),trackview=new TrackView(public_interface,piano),add_view("track",trackview),adminview=new AdminView(public_interface,piano),add_view("admin",adminview),searchview=new SearchView(public_interface,piano),add_view("search",searchview),seedview=new SeedView(public_interface,piano),add_view("seed",seedview),userview=new UserView(public_interface,piano),add_view("user",userview),$("#switcher").show()},terminate_session:function(){for(var e in views)e!="login"&&("destroy"in views[e]&&views[e].destroy(),delete views[e]);userview=undefined,seedview=undefined,adminview=undefined,sourceview=undefined,trackview=undefined,playlistview=undefined,activityview=undefined,pianod=undefined,$("#switcher").hide()},execute:function(e,t){piano.send_command(e,function(e){e.ok?typeof t=="undefined"?viewmanager.clear():viewmanager.success(t):viewmanager.error(e)})},close_accordion:function(e){var t=$("#"+e+" .accordion");t.each(function(e,t){$(t).find("h3").removeClass("selected")})},get_response_fields:function(e,t,n){var r=[];n=n||{};for(var i=0;i<t.length;i++){var s=t[i];if(s in n)r.push(s);else for(var o=0;o<e.length;o++)if(s in e[o]){r.push(s);break}}return r},render_table:function(e,t,n,r){var i=$(e+" thead"),s=$("<tr />");for(var o=0;o<n.length;o++){var u;typeof n[o]=="function"?u=n[o]():u=n[o];var a=$("<th />").text(translate("HEADING_"+u.toUpperCase()));typeof r!="undefined"&&a.attr("onclick",r+'("'+u+'");'),s.append(a)}i.html(s);var f=$(e+" tbody");f.text("");for(o=0;o<t.length;o++){var l=$("<tr />");for(var c=0;c<n.length;c++){var h="";typeof n[c]=="function"?h=n[c](t[o]):n[c]in t[o]&&(h=$("<span />").text(t[o][n[c]])),l.append($("<td />").append(h))}f.append(l)}},logout:function(){piano.send_command("QUIT")},protocol:function(){return protocol_version},toggle_menu:function(){$("#switcher.collapse .menu").toggle()}};return public_interface},ActivityView=function(e,t){function o(){if(i.length>0){var e=$("#recentactivity");e.text("");for(var t=0;t<i.length;t++)e.prepend($("<li/>").text(i[t]))}}var n=200,r=6,i=[],s=0;return t.subscribe([MSG.WELCOME,MSG.YELL,MSG.ACTIVITY,MSG.STATUS,MSG.SOURCESTATUS],function(e){i.push(e.text),i.length>n?(i=i.slice(25),o()):$("#recentactivity").append($("<li/>").text(e.text))}),t.send_command(["USERS","ONLINE"],function(e){if(e.ok){var n=t.get_sorted_column(e.record,"id");i=n.reverse().concat([translate("Listeners online:")],i)}else i.push(translate("Activity messages are disabled."));o()}),$("#yellmessage").entergize(function(){$("#yellbutton").click()}),{get_width:function(e,t,n){return n-=r,$("#recentactivity").css("height",n*2.5+"ex"),e==2&t==2?1:t>2?2:t},yell:function(){var n=$("#yellmessage").val().replace(/\n/g,"  ").replace('"',"'");n.match(/^\s*$/)?e.error("No message to yell."):($("#yellmessage").val(""),t.send_command(["YELL",n],function(e){e.ok||$("#yellmessage").val(n)}))}}},AdminView=function(e,t){return t.subscribe(MSG.QUEUERANDOMIZE,function(e){$("#queuerandomize").val(e.value)}),{select_room:function(){var t=$("#rooms").val();e.execute(["ROOM","ENTER",t])},select_queue_randomize:function(){var t=$("#queuerandomize").val();e.execute(["QUEUE","RANDOMIZE","BY",t])},open_select_room:function(){t.send_command(["ROOM","LIST"],function(t){if(t.ok){var n=$("#rooms").val();$("#rooms").text("");for(var r=0;r<t.record.length;r++){var i=t.record[r].room;li=$("<option />").prop("value",i).text(i),$("#rooms").append(li)}$("#rooms").val(n)}else e.error("Can not retrieve room list",": ",translate(t))})}}},LoginView=function(e,t){function d(t){t.ok?(e.clear(),l&&(localStorage.username=n,localStorage.server=i,localStorage.secure=s?"Secure":"",$("#storepassword").is(":checked")?localStorage.password=r:localStorage.removeItem("password")),a=STATE.CONNECTED,e.start_session(u),e.show("track"),setTimeout(function(){e.show("playlist")},900)):(e.error("Login failed"," ",t.text),u.send_command("QUIT"))}function v(){a=STATE.AUTHORIZING,n===""?d({ok:!0}):u.send_command(["USER",n,r],d)}function m(){e.get_view("login").show(),e.terminate_session(),a==STATE.DISCONNECTED&&i.indexOf(":")<0?e.error("Connection failed.","  ","Check port number."):e.error(a==STATE.DISCONNECTED?"Connection failed.":a==STATE.AUTHORIZING?"Bad user credentials.":"Session ended."),a=STATE.DISCONNECTED}STATE={CONNECTED:0,AUTHORIZING:1,DISCONNECTED:2};var n=localStorage.username||"",r=localStorage.password||"",i=localStorage.server||"house.perette.barella.org:4446",s=(localStorage.secure||"")=="Secure",o=!1,u,a=STATE.DISCONNECTED,f=!1,l=!0,c=!0,h,p=PianodFinder.get_url_info();typeof p!="undefined"&&(o=p.secure,c=p.fromweb,h=p.domain),c||$("#serverinput").hide(),"server"in t&&(i=t.server);if("login"in t){var g=t.login;g=="visitor"?(f=!0,l=!1):g=="auto"?f=!0:g=="login"?f=n!=="":(f=g==n&&n!=="",n===""&&(n=g))}return{show:function(){e.show("login",!0),e.reset(),$("#server").entergize(function(){$("#username").focus()}),$("#username").entergize(function(){$("#password").focus()}),$("#password").entergize(function(){$("#loginbutton").click()}),$("#username").val(n),$("#password").val(r),$("#storepassword").prop("checked",r!==""),$("#server").val(i),$("#secureserver").prop("checked",s),f&&(this.connect(!l),f=!1)},connect:function(t){i=$("#server").val(),s=$("#secureserver").is(":checked");var a=o||s,f=(a?"wss://":"ws://")+(c?i:h)+"/pianod?encoding=text";n=t?"":$("#username").val(),r=t?"":$("#password").val(),l=!t,e.success(translate("Opening connection to %1$s.",f)),u=new PianoConnection(f,v,m),typeof u=="undefined"&&e.error(i+": ","Connection failed.")},get_username:function(){return n},toggle_security:function(){var e=$("#secureserver").is(":checked"),t=$("#server").val(),n=t.split(":");n.length==2&&e&&n[1]=="4446"?$("#server").val(n[0]+":4447"):n.length==2&&!e&&n[1]==4447&&$("#server").val(n[0]+":4446")}}},PlaylistView=function(e,t){function v(e){return $("<span/>").rating(e.rating||0).click(function(){playlistview.rate_playlist(e.id,$(this).rating())})}function m(){var e=typeof r=="undefined"?u.length:Math.floor(r/i),t=e*o,n=Math.ceil(u.length/t);f>=n&&(f=n-1),f<0&&(f=0),$("#playlistpages").text(n),$("#playlistpage").text(f+1);var s=f*t,a=$("#playlistlist");a.text("");for(var l=0;l<t;l++){var c=$("<li/>");a.append(c);if(s<u.length){var h=u[s],p=v(h),d=$("<input/>");d.prop("checked",h.mix).attr("type","checkbox").attr("onclick",'playlistview.toggle_playlist ("'+h.id+'")').attr("id","playlistmix"+h.id);var m=$("<label/>");m.text(h.name).attr("onclick",'playlistview.select_playlist ("'+h.id+'")').attr("for","playlistmix"+h.id),c.append(p).append(d).append(m),s++}else c.html("&nbsp;")}}function g(n){var r;if(n.ok){u=[];var i=n.record;for(r=0;r<i.length;r++){var s="playlistrating"in i[r]?i[r].playlistrating.rated:0;u.push({name:i[r].playlist,source:i[r].sourcename,id:i[r].id,mix:!1,rating:s})}u=t.sort_on_field(u,"name");var o="";for(r=0;r<u.length;r++){var f=u[r].name.toLowerCase(),l=(r<u.length-1?u[r+1].name:"").toLowerCase();if(f==o||f==l)u[r].name+=" ("+u[r].source+")";o=f}m();for(r=0;r<a.length;r++)a[r](u)}else e.error(n)}function y(t){if(t.ok){var n=t.record;l=n.length>0;for(var r=0;r<u.length;r++)u[r].mix=!1;for(var r=0;r<n.length;r++)for(var i=0;i<u.length;i++)u[i].id==n[r].id&&(u[i].mix=!0)}else e.error(t);m()}function b(e){e.code!=MSG.MIX_CHANGED&&t.send_command(["PLAYLIST","LIST"],g),t.send_command(["MIX","LIST","INCLUDED"],y)}function w(){$("#selectmode").toggle(h!=c&&(h=="auto"||h=="mix")),$("#playlistlist").toggleClass("showmix",h=="mix"),$("#playlistlist").toggleClass("showratings",h=="auto"),$("#showmode").toggleClass("selected",c==h),$("#showmode").toggleClass("pending",c!=h);var e=h=="auto"?1.5:1;e!=i&&(i=e,m())}var n=3,r,i=1,s=15,o=1,u=[],a=[],f=0,l=!1,c="",h="playlist",p=!1,d=!1;return t.subscribe([MSG.PLAYLISTS_CHANGED,MSG.MIX_CHANGED,MSG.SOURCES_CHANGED,MSG.USERRATINGS_CHANGED,MSG.SELECTEDSOURCE],b),t.subscribe(MSG.SELECTEDPLAYLIST,function(e){var t=e.words[0];if(h==c||c==="")h=t,$("#showmode").val(t);c=t,w()},!1),t.subscribe(MSG.NOPLAYLIST,function(){c="",w()},!1),t.subscribe(MSG.FAILURE_PLAYER_EMPTY,function(){e.error("Please choose a playlist."),e.show("playlist")},!1),b(MSG.PLAYLISTS_CHANGED),t.send_command("STATUS",function(){}),{get_width:function(e,t,s){if(e==1)return r=undefined,m(),1;s-=n,r=s>0?s:1;var a=Math.floor(r/i);return o=Math.ceil(u.length/a),o===0&&(o=1),o>t&&(t==e&&t>1?o=t-1:o=t),m(),o},previous:function(){f--,m()},next:function(){f++,m()},select_playlist:function(t){h=="playlist"&&(e.execute(["PLAY","PLAYLIST","ID",t]),e.show("track"))},toggle_playlist:function(t){h=="mix"&&e.execute(["MIX","TOGGLE","ID",t])},rate_playlist:function(t,n){e.execute(["RATE","PLAYLIST",n,"ID",t])},change_shown_mode:function(){h=$("#showmode").val(),w()},select_mode:function(){e.execute(["PLAY",h]),e.show("track")},subscribe_to_playlists:function(e){a.push(e),e(u)},mix_selected:function(){return l},change_rooms:function(){b(MSG.PLAYLISTS_CHANGED),t.send_command("STATUS",function(){})}}},SearchView=function(view,piano){function get_name(e){return e.song||e.album||e.artist||e.genre}function get_type(e){return"song"in e?"song":"album"in e?"album":"artist"in e?"artist":"playlist"}function render(){piano.sort_on_field(results,sort_order),view.render_table("#searchresults",results,fields,"searchview.resort_on")}function render_action(e){var t=$("<span/>");return"action"in e&&e.action.request&&t.append($("<a />").text(translate("+Que")).addClass("button").attr("onclick",'searchview.add_to_queue ("'+e.id+'");')),t.append($("<a />").text(translate("+Seed")).addClass("button").attr("onclick",'searchview.show_seed_menu ("'+e.id+'");')),t}function render_song(e){return $("<a />").text(e.song).attr("onclick",'searchview.research ("song", "'+e.id+'");')}function render_album(e){return $("<a />").text(e.album).attr("onclick",'searchview.research ("album", "'+e.id+'");')}function render_artist(e){return $("<a />").text(e.artist).attr("onclick",'searchview.research ("artist", "'+e.id+'");')}function get_column_action(name){var funcname="render_"+name;if(eval("typeof ("+funcname+")")=="undefined")return name;var func=eval("render_"+name);return function(e){return typeof e=="undefined"?name:func(e)}}function perform_query(e){piano.send_command(e,function(e){view.report_status(e);if(e.ok){results=e.record,sort_order=view.get_response_fields(results,FIELDS,{action:!0}),fields=[];for(var t=0;t<sort_order.length;t++)fields.push(get_column_action(sort_order[t]));var n=sort_order.indexOf("action");n>=0&&sort_order.splice(n,1),render()}})}function refresh_results(){var e=$("#searchfor").val().trim(),t=$("#searchtype").val(),n=$("#searchmethod").val();if(e===""){view.error("Please enter a search query.");return}var r;t=="request"&&n=="expr"?r="SONG LIST WHERE "+e:t=="request"?r=["SONG","LIST",n,e]:n=="expr"?r="FIND WHERE "+e:n=="where"?r="FIND WHERE "+(t=="any"?"search":t)+' =~ "'+e.replace(RegExp('"',"g"))+'"':r=["FIND",t,n,e],perform_query(r)}function get_result_by_id(e){for(var t=0;t<results.length;t++)if(results[t].id==e)return results[t]}function update_playlists(e){var t=$("#addfromsearchtarget");t.find("option").slice(1).remove();for(i=0;i<e.length;i++)t.append($("<option />").prop("value",e[i].id).text(e[i].name))}var reserved_lines=6,item_height=2,FIELDS=["artist","album","song","genre","year","playlist","duration","action"],fields,sort_order,results,menu_item;return view.get_view("playlist").subscribe_to_playlists(update_playlists),$("#searchfor").enterclicks("#searchbutton"),{get_width:function(e,t,n){return e>1&&t==1?0:(n-=reserved_lines,n<7&&(n=7),$("#searchview table").css("height",n*2.5+"ex"),e==t&&e==4?t-1:t>4?4:t)},search:function(){refresh_results()},request:function(){var e=$("#searchfor").val(),t=$("#searchmethod").val();if(e===""){view.error("Please enter a search query.");return}var n;t=="expr"?n="SONG REQUEST WHERE "+e:n=["SONG","REQUEST",t,e.trim()],view.execute(n,"Songs queued.")},show_seed_menu:function(e){menu_item=get_result_by_id(e),$("#addfromsearchname").text(get_name(menu_item)),$("#addfromsearchtype").text(translate(get_type(menu_item))),$("#searchinfosource").text(menu_item.source),$("#searchinfoname").text(menu_item.sourcename),$("#searchaction").show()},add_seed:function(e){var t=$("#addfromsearchtarget").val();if(t==="")alert(translate("Please choose a target playlist."));else{var n=$("#addfromsearchtarget option:selected").text();view.execute(["SEED","ADD","ID",menu_item.id,"TO","PLAYLIST","ID",t],"Added "+get_name(menu_item)+" to "+n+"."),$("#searchaction").hide()}},create_playlist:function(){var e=$("#addfromsearchplaylist").val(),t=$("#addfromsearchsource").val();e===""?alert(translate("You must provide a name for the new playlist.")):(view.execute(["WITH","SOURCE","ID",t,"PLAYLIST","CREATE","NAME",e,"FROM","ID",menu_item.id],"Created "+e+"."),$("#searchaction").hide())},add_to_queue:function(e){var t=get_result_by_id(e);view.execute(["REQUEST","ID",e],"Added "+get_name(t)+" to the queue.")},resort_on:function(e){var t=sort_order.indexOf(e);sort_order.splice(t,1),sort_order.unshift(e),render()},research:function(kind,id){var item=get_result_by_id(id),value=eval("item."+kind).replace(RegExp('"',"g")),comparator=kind=="artist"?"=~":"==",kind_clause=kind=="artist"?"(TYPE=ARTIST|(!COMPILATION&TYPE=ALBUM)|(COMPILATION&TYPE=SONG))":"(TYPE="+kind+"|TYPE=SONG)"
;perform_query("FIND ALL WHERE "+kind_clause+" && "+kind+comparator+'"'+value+'"')}}},SeedView=function(e,t){function h(e){for(var t in n)if(e.rating[t])return t;return"rating"}function p(t){var n=t.song||t.album||t.artist||t.playlist||"";if(confirm("Are you sure you want to remove the seed for "+n+"?")){var r=h(t);r=="rating"?e.execute(["RATE","SONG","NEUTRAL","ID",t.id],"Rating removed"):e.execute(["SEED","DELETE","ID",t.id,"FROM","PLAYLIST","ID",c],"Seed "+n+"removed."),m()}}function d(e){return typeof e=="undefined"?"action":$("<a />").text("✖"+translate("Remove seed")).addClass("remove").click(function(){p(e)})}function v(){t.sort_on_field(l,o),e.render_table("#seedsexisting",l,u,"seedview.set_seed_sort")}function m(){var n=$("#reviseplaylist").val();n===""?(e.error("Please select a playlist."),$("#seedsexisting tbody").html("<tr><td>&nbsp;</td></tr>")):t.send_command(["SEED","LIST","PLAYLIST","ID",n],function(t){c=n,l=t.record;if(t.ok){l=t.record;for(var r=0;r<l.length;r++){var i=h(l[r]);i=="rating"&&(i+=" ("+l[r].rating.rated+")"),l[r].seedtype=i}u=e.get_response_fields(l,s),u.push(d),v()}else e.error(t)})}function g(e){var t=$("#reviseplaylist");t.find("option").slice(1).remove();for(i=0;i<e.length;i++)t.append($("<option />").prop("value",e[i].id).text(e[i].name))}var n={seed:"song",albumseed:"album",artistseed:"artist"},r=4,s=["artist","album","song","seedtype"],o=s,u,a=!1,f=[],l=[],c;return e.get_view("playlist").subscribe_to_playlists(g),{get_width:function(e,t,n){return t==1&&e>1?0:(n-=r,n<5&&(n=5),$("#seedview h3+div").css("height",n+"em"),a=t==1,t>3?3:t)},select_playlist:function(){m()},set_seed_sort:function(e){var t=o.indexOf(e);o.splice(t,1),o.unshift(e),v()},remove_playlist:function(){var t=$("#reviseplaylist").val(),n=$("#reviseplaylist option:selected").text();t===""?e.error("Please select a playlist."):confirm("Are you sure you want to remove "+n+"?")&&e.execute(["PLAYLIST","DELETE","ID",t])}}},SourceView=function(e,t){function o(e){var t=$("#sourcepicker");t.html("");for(var r=0;r<e.length;r++)t.append($("<option/>").text(e[r].fullname).attr("value",e[r].id));t.val(n)}function u(){t.send_command(["SOURCE","LIST","ENABLED"],function(n){if(!n.ok){e.error(n);return}var r=t.sort_on_field(n.record,["source","sourcename"]);for(var i=0;i<r.length;i++)r[i].fullname=r[i].source+" ("+r[i].sourcename+")";for(i=0;i<s.length;i++)s[i](r);r.length<=1&&(e.show("source",!0),e.error("Please provide some sources."))})}function a(e,t,n){var r=t?"borrowsource":"addsource",i="#"+r,s=!1;for(var o=0;o<e.length;o++){var u=e[o];$(i+"parameters label[for="+r+u+"]").toggle(n),$(i+"parameters label[for="+r+u+"_enable]").toggle(n);var a=$(i+u+"_enable");a.toggle(n);var f=a.length<1||a.prop("checked"),l=$(i+u);s=s||l.length>0&&f,l.toggle(n&&f)}return s}function f(){var e=$("#addsourcetype").val();for(var t in SOURCEFIELDS)a(SOURCEFIELDS[t],!1,!1);e!==""&&a(SOURCEFIELDS[e],!1,!0),$("#addsourcesongproxy option[value=donor]").prop("disabled",e=="pandora")}function l(){var e=$("#borrowlist"),t=e.prop("selectedIndex");for(var n in SOURCEFIELDS)a(SOURCEFIELDS[n],!0,!1);var i=!1;if(t>0){var s=r[t-1],i=a(SOURCEFIELDS[s.source],!0,!0);$("#borrowsourcesongproxy option[value=donor]").prop("disabled",s.source=="pandora")}i=i||$("#borrowsourceaccess").val()!==""||$("#borrowsourcesongproxy").val()!==""}function c(t,n,r){var i=n?"#borrowsource":"#addsource",s=SOURCEFIELDS[t];for(var o=0;o<s.length;o++){var u=s[o],a=u in FIELDS?FIELDS[u]:[];if(n&&$.inArray("borrow",a)<0)continue;var f=$(i+u+"_enable"),l=f.length<1||f.prop("checked");if(!l)continue;var c=i+u,h;if($.inArray("check")>=0)var h=$(c).prop("checked");else{var h=$(c).val().trim();if(h==""&&$.inArray("optional",a)>=0)continue;if(h==""&&$.inArray("null",a)<0)return e.error(translate("ADDSOURCE_NULL_"+u.toUpperCase())),!1}switch(u){case"pandoraone":h&&r.push("ONE");break;case"recentbias":r.push("RECENT","BIAS",h);break;case"ratingbias":r.push("RATING","BIAS",h);break;case"user":case"rescan":r.push(u);default:r.push(h)}}var p=$(i+"persistence").val();p!=""&&r.push(p);var d=$(i+"access").val();d!==""&&r.push("ACCESS",d);var v=$(i+"songproxy").val();return v!=""&&r.push("SONG","PROXY",v),!0}function h(){var t=$("#addsourcetype").val();if(t==""){e.error("Please select a source type.");return}var n=[t];t=="tonegenerator"?n.push("ACTIVATE"):t=="filesystem"&&n.push("ADD");if(!c(t,!1,n))return;var r=$("#addsourcename").val().trim();r!==""&&n.push("NAME",r),e.show("track"),e.execute(n,"Source added, may take a moment to be ready.")}function p(){var t=$("#borrowlist"),n=t.prop("selectedIndex");if(n<=0)e.error("Please select a source to use.");else{var i=r[n-1],s=[i.source,"USE",i.sourcename];c(i.source,!0,s)&&(e.execute(s,"Source added, may take a moment to be ready."),$("#borrowsourceparameters select").prop("selectedIndex",0),l())}}SOURCEFIELDS={pandora:["pandoraone","user","password"],filesystem:["path","rescan","ratingbias","recentbias"],tonegenerator:["ratingbias","recentbias"]},FIELDS={pandoraone:["check"],password:["null"],rescan:["borrow","optional"],ratingbias:["borrow"],recentbias:["borrow"]};var n="1",r=[],i=[],s=[];return t.subscribe(MSG.SOURCES_CHANGED,u),s.push(o),t.subscribe(MSG.SELECTEDSOURCE,function(e){n=e.words[0],$("#sourcepicker").val(n)}),t.send_command(["SOURCE","LIST","TYPE"],function(e){var n=$("#addsourcetype");n.find("option").slice(1).remove();var r=t.get_sorted_column(e.record,"source");for(var i=0;i<r.length;i++)n.append($("<option/>").text(r[i]).prop("disabled",r[i]=="manager"))}),u(),f(),l(),{select_source:function(){var t=$("#sourcepicker").val();e.execute(["SOURCE","SELECT","ID",t],"Source selected.")},select_add_fields:function(){f()},add_source:function(){h()},remove_source:function(){e.execute(["SOURCE","DELETE","ID",n])},open_borrowsource:function(){t.send_command(["SOURCE","LIST","AVAILABLE"],function(n){if(!n.ok){e.error(n);return}var i=$("#borrowlist");i.find("option").slice(1).remove(),r=t.sort_on_field(n.record,["source","sourcename"]);for(var s=0;s<r.length;s++)i.append($("<option/>").text(r[s].source+" ("+r[s].sourcename+")"));i.prop("selectedIndex",0)})},select_borrow_fields:function(){l()},borrow_source:function(){p()},subscribe_to_sources:function(e){s.push(e),e(i)}}},UserView=function(e,t){function n(t,n){var r=$(t).val(),i=$(n).val();return r==i?r:(e.error("New passwords do not match."),undefined)}function r(t){return $("<a />").text("╳").addClass("remove").click(function(){e.execute(["KICK","USER",t]),userview.open_kick_user()})}return{change_password:function(){var t=$("#shadowpassword").prop("checked"),r=$("#oldpassword").val(),i;if(t)i=["SET","SHADOW","PASSWORD",r,$("#newpassword").val()];else{var s=n("#newpassword","#confirmpassword");typeof s!="undefined"&&(i=["SET","PASSWORD",r,s])}typeof i!="undefined"&&e.execute(i,"Password successfully updated.")},change_shadow:function(){var e=$("#shadowpassword").prop("checked");$("label[for=oldpassword]").text(translate(e?"pianod password":"Old password")),$("label[for=newpassword]").text(translate(e?"System password":"New password")),$("#confirmpassword").toggle(!e),$("label[for=confirmpassword]").toggle(!e)},create_user:function(){var t=$("#createusername").val(),r=$("#createusertype").val(),i=n("#createpassword","#createconfirmpassword");typeof i!="undefined"&&e.execute(["CREATE",r,t,i],translate("User %1$s updated.",t))},open_alter_user:function(){t.send_command(["USERS","LIST"],function(n){if(n.ok){var r=t.get_sorted_column(n.record,"id"),i=$("#alterusername");i.find("option").slice(1).remove();for(var s=0;s<r.length;s++)i.append($("<option />").text(r[s]).attr("value",r[s]))}else e.error("Can not retrieve user list")})},select_alter_user:function(){var e=$("#alterusername").val();e!==""&&t.send_command(["USERS","LIST",e],function(e){if(e.ok&&e.data.length==1){var t=e.data[0][MSG.PRIVILEGES];$("#alterusertype").val(t.words[0]),all_privileges=["influence","service"];for(var n=0;n<all_privileges.length;n++){var r=all_privileges[n];$("#privilege"+r).prop("checked",t.wordflags[r])}}})},change_type:function(){var t=$("#alterusername").val(),n=$("#alterusertype").val();t===""?e.error("Please select a user."):e.execute(["SET","USER","RANK",t,n],"User "+t+" updated.")},change_privilege:function(t){var n=$("#alterusername").val(),r=$("#privilege"+t).prop("checked");n===""?e.error("Please select a user."):e.execute([r?"GRANT":"REVOKE",t,r?"TO":"FROM",n],translate("User %1$s updated.",n))},reset_password:function(){var t=$("#alterusername").val();if(t==="")e.error("Please select a user.");else{var n=confirm(translate("This will clear %1$s's password\nso they can login without a password.\nThis is insecure.  Are you sure?",t));n&&e.execute(["SET","USER","PASSWORD",t,""],"Password reset for "+t+".")}},delete_user:function(){var t=$("#alterusername").val();if(t==="")e.error("Please select a user.");else{var n=confirm(translate("Are you sure you want to delete %1$s?",t));n&&(e.execute(["DELETE","USER",t],translate("User %1$s updated.",t)),this.open_alter_user())}},open_kick_user:function(){t.send_command(["USERS","ONLINE"],function(t){if(t.ok){var n,i;$("#onlineusers").text("");for(var s=0;s<t.record.length;s++){var o=t.record[s].id;n=r(o),i=$("<li />").append(n).append($("<span />").text(" "+o)),$("#onlineusers").append(i)}n=$("<a />").text("╳").addClass("remove").click(function(){e.execute(["KICK","VISITORS"]),userview.open_kick_user()}),i=$("<li />").append(n).append($("<span />").text(" All Visitors")),$("#onlineusers").append(i)}else e.error("Can not retrieve user list",": ",translate(t))})}}};
